---
import AuthLayout from "@/layouts/AuthLayout.astro";
import LoginForm from "@/components/auth/LoginForm";

export const prerender = false;

const sanitizeRedirectPath = (value: string | null) => {
  if (!value) {
    return undefined;
  }

  if (!value.startsWith("/") || value.startsWith("//")) {
    return undefined;
  }

  if (value.includes("..") || value.includes("\\")) {
    return undefined;
  }

  return value;
};

if (Astro.locals.user) {
  return Astro.redirect("/app/dashboard");
}

const redirectTo = sanitizeRedirectPath(Astro.url.searchParams.get("redirectTo"));
const initialEmail = Astro.url.searchParams.get("email") ?? undefined;
---

<AuthLayout title="Zaloguj sie | Greenie">
  <LoginForm client:load redirectTo={redirectTo} initialEmail={initialEmail} />
</AuthLayout>
